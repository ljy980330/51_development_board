C51 COMPILER V9.01   IIC                                                                   07/09/2019 14:46:06 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\iic.obj
COMPILER INVOKED BY: D:\cx\C51\BIN\C51.EXE iic\iic.c BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\iic.lst) OBJECT(.\Object
                    -s\iic.obj)

line level    source

   1          /*********************************************************************************************************
   2          *名称：iic.c
   3          *功能：iic包括的函数
   4          创建时间：2019/XX/XX
   5          修改时间：2019/6/5
   6          作者：XXX
   7          *********************************************************************************************************/
   8          #include <STC12C5A.H>
   9          #include <intrins.h>
  10          #include "iic.h"         
  11          #include "config.h"     
  12          #include "delay/delay.h"
  13          
  14          uchar display_buff[16];
  15          uchar RTC_Data[8];
  16          uchar RTC_Data1[8];
  17          uchar RTC_Set_ID;
  18          code uchar rtc_address[8]={0x00,0x01,0x02,0x04,0x05,0x03,0x06,0x11};//秒分时日月周年 最低位读写位
  19                          
  20          /*******************************************************************************
  21          * 函 数 名         : DS3231_IIC_delay
  22          * 函数功能                 : IIC延时函数。延时4个机器周期。   
  23          *******************************************************************************/                         
  24          void DS3231_IIC_delay()
  25          {
  26   1              nop(4);
  27   1      }                               
  28          
  29          /*******************************************************************************
  30          * 函 数 名         : DS3231_IIC_start
  31          * 函数功能                 : 起始信号
  32          *******************************************************************************/
  33          void DS3231_IIC_start()
  34          {   
  35   1           DS3231_IIC_SDA=1;
  36   1           DS3231_IIC_SCL=1;
  37   1           DS3231_IIC_delay();
  38   1           DS3231_IIC_SDA=0;
  39   1           DS3231_IIC_delay();
  40   1           DS3231_IIC_SCL=0;
  41   1      }
  42                  
  43          /*******************************************************************************
  44          * 函 数 名         : DS3231_IIC_stop
  45          * 函数功能                 : 停止信号
  46          *******************************************************************************/
  47          void DS3231_IIC_stop()
  48          {
  49   1          DS3231_IIC_SDA=0;
  50   1          DS3231_IIC_delay();
  51   1          DS3231_IIC_SCL=1;
  52   1          DS3231_IIC_delay();
  53   1          DS3231_IIC_SDA=1;
  54   1          DS3231_IIC_delay();
C51 COMPILER V9.01   IIC                                                                   07/09/2019 14:46:06 PAGE 2   

  55   1      }
  56                   
  57          /*******************************************************************************
  58          * 函 数 名         : DS3231_IIC_Tack
  59          * 函数功能                 : 接收应答
  60          *******************************************************************************/
  61          bit DS3231_IIC_Tack()
  62          {
  63   1          bit ack;
  64   1          DS3231_IIC_SDA=1;
  65   1          DS3231_IIC_delay();
  66   1          DS3231_IIC_SCL=1;
  67   1          DS3231_IIC_delay();
  68   1          ack=DS3231_IIC_SDA;
  69   1          DS3231_IIC_delay();
  70   1          DS3231_IIC_SCL=0;
  71   1          DS3231_IIC_delay();
  72   1          return ack;
  73   1      }
  74                  
  75          /*******************************************************************************
  76          * 函 数 名         : DS3231_IIC_write_byte
  77          * 函数功能                 : 写入数据函数
  78          *******************************************************************************/
  79          void DS3231_IIC_write_byte(uchar Data)
  80          {
  81   1              uchar i;
  82   1              for(i=0;i<8;i++)
  83   1              {
  84   2                      if(Data&0x80)
  85   2                      DS3231_IIC_SDA=1;
  86   2                      else
  87   2                      DS3231_IIC_SDA = 0;
  88   2                      DS3231_IIC_delay();
  89   2                      DS3231_IIC_SCL=1; 
  90   2                      DS3231_IIC_delay();
  91   2                      DS3231_IIC_SCL=0;
  92   2                      DS3231_IIC_delay();
  93   2                      Data=Data<<1;
  94   2              }
  95   1      }
  96             
  97          /*******************************************************************************
  98          * 函 数 名         : DS3231_IIC_read_byte
  99          * 函数功能                 : 读取数据函数
 100          *******************************************************************************/
 101          uchar DS3231_IIC_read_byte()
 102          {
 103   1          uchar i;
 104   1          uchar Data;       
 105   1          for(i=0;i<8;i++)
 106   1          {
 107   2              DS3231_IIC_SCL=1;
 108   2              DS3231_IIC_delay();
 109   2              Data=Data<<1;
 110   2              DS3231_IIC_delay();
 111   2             
 112   2              if(DS3231_IIC_SDA)
 113   2              Data=Data|0x01;
 114   2              DS3231_IIC_SCL=0;
 115   2              DS3231_IIC_delay();
 116   2          }
C51 COMPILER V9.01   IIC                                                                   07/09/2019 14:46:06 PAGE 3   

 117   1          return Data;
 118   1      }
 119          /*******************************************************************************
 120          * 函 数 名         : DS3231_IIC_single_byte_write
 121          * 函数功能                 : 写入数据函数
 122          *******************************************************************************/
 123          void DS3231_IIC_single_byte_write(uchar Waddr,uchar Data)
 124          {
 125   1          DS3231_IIC_start();
 126   1          DS3231_IIC_write_byte(0xd0);
 127   1          DS3231_IIC_Tack();
 128   1          DS3231_IIC_write_byte(Waddr);
 129   1          DS3231_IIC_Tack();
 130   1          DS3231_IIC_write_byte(Data);
 131   1          DS3231_IIC_Tack();
 132   1          DS3231_IIC_stop();
 133   1      }
 134          /*******************************************************************************
 135          * 函 数 名         : DS3231_IIC_single_byte_read
 136          * 函数功能                 : 读取数据函数
 137          *******************************************************************************/
 138          uchar DS3231_IIC_single_byte_read(uchar Waddr)
 139          {
 140   1          uchar Data;
 141   1          DS3231_IIC_start();
 142   1          DS3231_IIC_write_byte(0xd0);
 143   1          DS3231_IIC_Tack();
 144   1          DS3231_IIC_write_byte(Waddr);
 145   1          DS3231_IIC_Tack();
 146   1          DS3231_IIC_stop();
 147   1          DS3231_IIC_start();
 148   1          DS3231_IIC_write_byte(0xd1);
 149   1          DS3231_IIC_Tack();
 150   1          Data=DS3231_IIC_read_byte();
 151   1          DS3231_IIC_delay();
 152   1          DS3231_IIC_stop();
 153   1          return Data;
 154   1      }
 155          /*******************************************************************************
 156          * 函 数 名         : DS3231_Read_time
 157          * 函数功能                 : 读取时间
 158          *******************************************************************************/
 159          void DS3231_Read_time()
 160          {
 161   1          uchar i,tmp,tmp1,tmp2;         
 162   1          for(i=0;i<8;i++)
 163   1          {
 164   2              tmp = DS3231_IIC_single_byte_read(rtc_address[i]);
 165   2              tmp1 = tmp/16;
 166   2              tmp2 = tmp%16;
 167   2                      RTC_Data[i]=tmp1*10+tmp2;
 168   2          }   
 169   1      }
 170          /*******************************************************************************
 171          * 函 数 名         : DS3231_write_time
 172          * 函数功能                 : 写入时间
 173          *******************************************************************************/
 174          void DS3231_write_time()
 175          {
 176   1          uchar i,tmp;
 177   1          for(i=0;i<7;i++)
 178   1          {       
C51 COMPILER V9.01   IIC                                                                   07/09/2019 14:46:06 PAGE 4   

 179   2              tmp=RTC_Data[i]/10;//BCD处理
 180   2              RTC_Data1[i]=RTC_Data[i]%10;
 181   2              RTC_Data1[i]=RTC_Data1[i]+tmp*16;
 182   2          } 
 183   1          for(i=0;i<7;i++)
 184   1          {
 185   2              DS3231_IIC_single_byte_write(rtc_address[i],RTC_Data1[i]);
 186   2          }
 187   1          DS3231_IIC_single_byte_write(0x0e,0x0c);
 188   1      }
 189          /*******************************************************************************
 190          * 函 数 名         : DS3231_Init
 191          * 函数功能                 : DS3231初始化
 192          *******************************************************************************/
 193          void DS3231_Init()
 194          {
 195   1          DS3231_IIC_SDA=1;
 196   1          DS3231_IIC_SCL=1;
 197   1          DS3231_IIC_single_byte_write(0x0e,0x0c);
 198   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    370    ----
   CONSTANT SIZE    =      8    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     33      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
