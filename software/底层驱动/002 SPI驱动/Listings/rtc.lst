C51 COMPILER V9.01   RTC                                                                   07/09/2019 17:14:04 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE RTC
OBJECT MODULE PLACED IN .\Objects\rtc.obj
COMPILER INVOKED BY: D:\cx\C51\BIN\C51.EXE rtc\rtc.c BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\rtc.lst) OBJECT(.\Object
                    -s\rtc.obj)

line level    source

   1          /*********************************************************************************************************
   2          *名称：rtc.c
   3          *功能：ds3231时钟驱动函数
   4          创建时间：2019/7/9
   5          修改时间：2019/7/9
   6          作者：黄彦钊
   7          *********************************************************************************************************/
   8          #include <STC12C5A.H>
   9          
  10          xdata uchar year,month,date,day,hour,min,sec,DTemp=0;
*** ERROR C129 IN LINE 10 OF RTC\RTC.C: missing ';' before 'year'
  11          xdata uchar al1_min,al1_hour,al1_day,al2_min,al2_hour,al2_day;
  12          bit ack;
  13           
  14          /*******************************************************************************
  15          * 函 数 名         : BCD2HEX
  16          * 函数功能                 : BCD转换为Byte
  17          *******************************************************************************/
  18          uchar BCD2HEX(uchar val)   
  19          {
  20          uchar i;
  21              i= val&0x0f;
  22              val >>= 4;                  
  23              val &= 0x0f;
  24              val *= 10;
  25              i += val;
  26              
  27              return i;
  28          }
  29          
  30          /*******************************************************************************
  31          * 函 数 名         : B_BCD
  32          * 函数功能                 : B码转换为BCD码
  33          *******************************************************************************/
  34          uchar B_BCD(uchar val)
  35          {
  36          uchar i,j,k;
  37          
  38            i=val/10;
  39            j=val%10;
  40            k=j+(i<<4);
  41            return k;
  42          }
  43          /*******************************************************************************
  44          * 函 数 名         : delayus
  45          * 函数功能                 : 没有一定延迟时间，时序使用
  46          *******************************************************************************/
  47          void delayus(uchar i)
  48          {
  49             while(--i) ;
  50          }                 
  51          /*******************************************************************************
  52          * 函 数 名         : Start
  53          * 函数功能                 : 起始
C51 COMPILER V9.01   RTC                                                                   07/09/2019 17:14:04 PAGE 2   

  54          *******************************************************************************/
  55          void Start()
  56          {
  57              SDA=1;                  //发送起始条件的数据信号
  58              delayus(1);
  59              SCL=1;
  60              delayus(5);             //起始条件建立时间大于4.7us,延时
  61             
  62              SDA=0;                  //发送起始信号
  63              delayus(5);             // 起始条件锁定时间大于4μs
  64                 
  65              SCL=0;                  //钳住I2C总线，准备发送或接收数据
  66              delayus(2);
  67          } 
  68          /*******************************************************************************
  69          * 函 数 名         : Stop
  70          * 函数功能                 : 结束
  71          *******************************************************************************/
  72          void Stop()
  73          {
  74              SDA=0;                  //发送结束条件的数据信号
  75              delayus(1);             //发送结束条件的时钟信号
  76              SCL=1;                  //结束条件建立时间大于4us
  77              delayus(5);
  78             
  79              SDA=1;                  //发送I2C总线结束信号
  80              delayus(4);
  81          }
  82          /*******************************************************************************
  83          * 函 数 名         : SendByte
  84          * 函数功能                 : 字节数据发送函数
  85                                                   将数据c发送出去,可以是地址,也可以是数据,发完后等待应答,并对
  86                                                   此状态位进行操作.(不应答或非应答都使ack=0)
  87                                           ack=1        发送数据正常， 
  88                                       ack=0        被控器无应答或损坏。
  89          *******************************************************************************/
  90          void SendByte(uchar Dat)
  91          {
  92          uchar BitCnt;
  93             
  94              for(BitCnt=0;BitCnt<8;BitCnt++)         //要传送的数据长度为8位
  95              {
  96                  if((Dat<<BitCnt)&0x80)
  97                      SDA=1;                          //判断发送位
  98                  else 
  99                      SDA=0;               
 100                    delayus(1);
 101                    SCL=1;                            //置时钟线为高，通知被控器开始接收数据位
 102                    delayus(5);                       //保证时钟高电平周期大于4μs   
 103                    SCL=0;
 104              }
 105             
 106              delayus(2);
 107              SDA=1;                                  //8位发送完后释放数据线，准备接收应答位
 108              delayus(2);  
 109              SCL=1;
 110              delayus(3);
 111              if(SDA==1)
 112                  ack=0;    
 113              else
 114                  ack=1;                              //判断是否接收到应答信号
 115              SCL=0;
C51 COMPILER V9.01   RTC                                                                   07/09/2019 17:14:04 PAGE 3   

 116              delayus(2);
 117          }
 118          /*******************************************************************************
 119          * 函 数 名         : RcvByte
 120          * 函数功能                 : 字节数据接收函数
 121                                                   用来接收从器件传来的数据,并判断总线错误(不发应答信号)，
 122                                           发完后请用应答函数应答从机。
 123          *******************************************************************************/
 124          uchar RcvByte()
 125          {
 126          uchar retc;
 127          uchar BitCnt;
 128           
 129             retc=0;
 130             SDA=1;                           //置数据线为输入方式
 131             for(BitCnt=0;BitCnt<8;BitCnt++)
 132             {
 133                  delayus(1);  
 134                  SCL=0;                      //置时钟线为低，准备接收数据位
 135                 
 136                  delayus(5);                 //时钟低电平周期大于4.7μs
 137                
 138                  SCL=1;                      //置时钟线为高使数据线上数据有效
 139                  delayus(3);
 140                  retc=retc<<1;
 141                  if(SDA==1)
 142                      retc=retc+1;            //读数据位,接收的数据位放入retc中
 143                  delayus(2);
 144             }
 145             SCL=0;
 146             delayus(2);
 147             return(retc);
 148          }
 149          /*******************************************************************************
 150          * 函 数 名         : I2CACK
 151          * 函数功能                 : 主控器进行应答信号(可以是应答或非应答信号，由位参数a决定)
 152          *******************************************************************************/
 153          void I2CACK(bit a)
 154          {
 155           
 156              if(a==0)
 157                  SDA=0;              //在此发出应答或非应答信号
 158              else
 159                  SDA=1;
 160              delayus(3);     
 161              SCL=1;
 162             
 163              delayus(5);             //时钟低电平周期大于4μs
 164             
 165              SCL=0;                  //清时钟线，钳住I2C总线以便继续接收
 166              delayus(2);   
 167          }
 168          /*******************************************************************************
 169          * 函 数 名         : I2CWrite
 170          * 函数功能                 : 将一个字节写入DS3231指定的地址
 171          *******************************************************************************/
 172          uchar I2CWrite(uchar addr,uchar bytedata)
 173          {
 174                  Start();
 175              SendByte(ADDRTC);
 176              if (ack == 0)
 177                  return 0;
C51 COMPILER V9.01   RTC                                                                   07/09/2019 17:14:04 PAGE 4   

 178             
 179              SendByte(addr);   
 180              if (ack == 0)
 181                  return 0;
 182             
 183              SendByte(bytedata);
 184              if (ack == 0)
 185                  return 0;
 186             
 187              Stop();
 188              delayus(10);      
 189              return 1;
 190          }  
 191          /*******************************************************************************
 192          * 函 数 名         : I2CRead
 193          * 函数功能                 : 从DS3231当前地址读一个字节
 194          *******************************************************************************/
 195          uchar I2CRead()
 196          {
 197          uchar read_data;
 198          
 199              Start();
 200              SendByte(ADDRTC+1);
 201              if(ack==0)
 202              {
 203                          DisplayChar(11,1,'t');
 204                          return(0);
 205                  }       
 206              read_data = RcvByte();
 207              I2CACK(1);
 208              Stop();
 209              return read_data;
 210          }
 211          
 212          /*******************************************************************************
 213          * 函 数 名         : I2CReadAdd
 214          * 函数功能                 : 从DS3231指定地址读一个字节
 215          *******************************************************************************/
 216          uchar I2CReadAdd(uchar addr)
 217          {
 218              Start();
 219              SendByte(ADDRTC);
 220              if(ack==0)
 221              {
 222                          DisplayChar(12,1,'x');
 223                          return(0);
 224                  }       
 225              SendByte(addr);
 226              if(ack==0)
 227              {
 228                          DisplayChar(13,1,'y');
 229                          return(0);
 230                  }       
 231              return(I2CRead());
 232          }

C51 COMPILATION COMPLETE.  0 WARNING(S),  1 ERROR(S)
