C51 COMPILER V9.00   ULTRASONIC                                                            07/26/2019 17:10:24 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ULTRASONIC
OBJECT MODULE PLACED IN .\Objects\Ultrasonic.obj
COMPILER INVOKED BY: F:\workApp\Keil_v5\C51\BIN\C51.EXE Ultrasonic\Ultrasonic.c BROWSE DEBUG OBJECTEXTEND PRINT(.\Listin
                    -gs\Ultrasonic.lst) OBJECT(.\Objects\Ultrasonic.obj)

line level    source

   1          //超声波模块程序
   2          //Trig  = P3^7
   3          //Echo  = P3^2
   4          #include <STC12C5A.H>                     
   5          #include "config.h"                               
   6          #include "delay/delay.h"         
   7          #include <led/led.h> 
   8          extern uchar LED[8];    //用于LED的8位显示缓存
   9          
  10          uint distance;
  11          uint test =0;           
  12          uint time = 0;
  13          uint timeH = 0;
  14          uint timeL = 0;
  15          uint succeed_flag;
  16           
  17           
  18          sbit Trig  = P3^7;
  19          sbit Echo  = P3^2;
  20           
  21          //
  22          //***************************************************************
  23          //显示数据转换程序
  24          void display(uint temp) 
  25           { 
  26   1          uchar qian,ge,shi,bai;
  27   1              qian = temp/1000;
  28   1          bai=temp/100%10;
  29   1          shi=temp%100/10;  
  30   1          ge=temp%10;
  31   1              
  32   1              LED[4]=qian;
  33   1              LED[3]=bai;
  34   1              LED[2]=shi;
  35   1              LED[1]=ge;
  36   1              
  37   1       }       
  38           void init()
  39           {
  40   1          Trig=0;       //首先拉低脉冲输入引脚
  41   1          EA=1;         //打开总中断0 
  42   1          TMOD=0x10;    //定时器1，16位工作方式 
  43   1       }
  44           void run()
  45           {              
  46   1                      EA=0;           //关总中断
  47   1                  Trig=1;         //超声波输入端
  48   1                  delay_us(20);   //延时20us
  49   1                  Trig=0;         //产生一个20us的脉冲
  50   1                  while(Echo==0); //等待Echo回波引脚变高电平
  51   1                  succeed_flag=0; //清测量成功标志
  52   1                  EA=1; 
  53   1                  EX0=1;          //打开外部中断0
  54   1                  TH1=0;          //定时器1清零
C51 COMPILER V9.00   ULTRASONIC                                                            07/26/2019 17:10:24 PAGE 2   

  55   1                  TL1=0;          //定时器1清零
  56   1                  TF1=0;          //计数溢出标志
  57   1                  TR1=1;          //启动定时器1
  58   1                  TR1=0;          //关闭定时器1
  59   1                  EX0=0;          //关闭外部中断0
  60   1                 if(succeed_flag==1)
  61   1                 {   
  62   2                    time=timeH*256+timeL;
  63   2                    distance=time*0.172;  //厘米
  64   2                 }                         
  65   1                if(succeed_flag==0)
  66   1                 {
  67   2                    distance=0;                    //没有回波则清零
  68   2                    test = !test;                  //测试灯变化
  69   2                  }                             
  70   1                      if(distance>=9999)
  71   1                              distance=0;
  72   1                      else
  73   1                      display(distance);
  74   1                      LED4_Display ();
  75   1       }
  76          //***************************************************************
  77          //外部中断0，用做判断回波电平
  78          void exter()  interrupt 0   // 外部中断0是0号
  79           {   
  80   1           timeH =TH1;    //取出定时器的值
  81   1           timeL =TL1;    //取出定时器的值
  82   1           succeed_flag=1;//至成功测量的标志
  83   1           EX0=0;         //关闭外部中断       
  84   1       }
  85          //****************************************************************
  86          //定时器1中断,用做超声波测距计时
  87          void timer1() interrupt 3  //
  88          {
  89   1           TH1=0;
  90   1           TL1=0;
  91   1       }      


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    273    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
